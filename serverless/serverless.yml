service: ubi-serverless

package:
  individually: true

# custom variables
custom:
  # Our stage is based on what is passed in when running serverless
  # commands. Or fallsback to what we have set in the provider section.
  stage: ${opt:stage, self:provider.stage}
  # The table name is based on the stage we are deploying to
  usersTableName: ${self:custom.stage}-users
  signaturesTableName: ${self:custom.stage}-signatures
  municipalitiesTableName: ${self:custom.stage}-municipalities
  userMunicipalityTableName: ${self:custom.stage}-users-municipalities
  imageBucketName: ${opt:projectName, 'xbge'}-${self:custom.stage}-profile-pics
  listsBucketName: ${opt:projectName, 'xbge'}-${self:custom.stage}-signature-lists
  output:
    handler: scripts/outputStack.handler
  # If you enable caching globally, it does NOT automatically enable
  # caching for your endpoints - you have to be explicit about which endpoints should have caching enabled.
  apiGatewayCaching:
    enabled: true

provider:
  name: aws
  runtime: nodejs12.x
  stage: dev
  region: eu-central-1
  memorySize: 512 # Overwrite the default memory size. Default is 1024
  layers:
    # Google Chrome for AWS Lambda as a layer
    # Make sure you use the latest version depending on the region
    # https://github.com/shelfio/chrome-aws-lambda-layer
    - arn:aws:lambda:${self:provider.region}:764866452798:layer:chrome-aws-lambda:20

  timeout: 10
  # These environment variables are made available to our functions
  # under process.env.
  environment:
    USERS_TABLE_NAME: ${self:custom.usersTableName}
    SIGNATURES_TABLE_NAME: ${self:custom.signaturesTableName}
    MUNICIPALITIES_TABLE_NAME: ${self:custom.municipalitiesTableName}
    USER_MUNICIPALITY_TABLE_NAME: ${self:custom.userMunicipalityTableName}
    STAGE: ${self:custom.stage}
    MAP_IMAGE_BUCKET: xbge-map-images
    IMAGE_BUCKET: ${self:custom.imageBucketName}
    SIGNATURE_LISTS_BUCKET: ${self:custom.listsBucketName}
  # S3 configuration here, we don't need to define the bucket in resources
  # https://www.serverless.com/framework/docs/providers/aws/events/s3/
  s3:
    imageBucket:
      name: ${self:custom.imageBucketName}
      corsConfiguration:
        CorsRules:
          - AllowedHeaders:
              - '*'
            AllowedMethods:
              - 'PUT'
            AllowedOrigins:
              - '*'

plugins:
  - serverless-iam-roles-per-function
  - serverless-webpack
  - serverless-plugin-split-stacks # needed because of the 200 resources limit
  - serverless-api-gateway-caching

# no global iam policies, because we want to follow the least privilege princilpe
# therefore we use a plugin to define roles per function

functions:
  createPledge:
    handler: src/api/pledges/createPledge/index.handler
    events:
      - http:
          path: users/{userId}/pledges
          method: post
          cors: true
          request:
            parameters:
              paths:
                userId: true # not optional
          authorizer:
            type: COGNITO_USER_POOLS
            authorizerId:
              Ref: ApiGatewayAuthorizer
    iamRoleStatements:
      - Effect: 'Allow'
        Action:
          - dynamodb:GetItem
          - dynamodb:UpdateItem
        Resource:
          - 'Fn::GetAtt': [UsersTable, Arn]

  updatePledge:
    handler: src/api/pledges/updatePledge/index.handler
    events:
      - http:
          path: users/{userId}/pledges
          method: patch
          cors: true
          request:
            parameters:
              paths:
                userId: true # not optional
          authorizer:
            type: COGNITO_USER_POOLS
            authorizerId:
              Ref: ApiGatewayAuthorizer
    iamRoleStatements:
      - Effect: 'Allow'
        Action:
          - dynamodb:GetItem
          - dynamodb:UpdateItem
        Resource:
          - 'Fn::GetAtt': [UsersTable, Arn]

  createSignatureList:
    handler: src/api/signatures/createSignatureList/index.handler
    events:
      - http:
          path: signatures
          method: post
          cors: true
    memorySize: 1600 # memorySize for this specific function.
    timeout: 12 # Timeout for this specific function.
    iamRoleStatements:
      - Effect: 'Allow'
        Action:
          - dynamodb:GetItem
          - dynamodb:Scan
          - dynamodb:UpdateItem
        Resource:
          - 'Fn::GetAtt': [UsersTable, Arn]
      - Effect: 'Allow' # for the global secondary index
        Action:
          - dynamodb:Query
        Resource:
          - Fn::Join:
              - '/'
              - - { 'Fn::GetAtt': ['UsersTable', 'Arn'] }
                - 'index/emailIndex'
      - Effect: 'Allow'
        Action:
          - dynamodb:PutItem
          - dynamodb:GetItem
          - dynamodb:Scan
          - dynamodb:Query
          - dynamodb:UpdateItem
        Resource:
          - 'Fn::GetAtt': [SignaturesTable, Arn]
      - Effect: 'Allow'
        Action:
          - ses:SendEmail
          - ses:SendRawEmail
        Resource: 'arn:aws:ses:eu-central-1:550953582247:identity/support@expedition-grundeinkommen.de'
      - Effect: 'Allow'
        Action:
          - s3:PutObject
          - s3:PutObjectAcl
        Resource: 'arn:aws:s3:::${self:custom.listsBucketName}/*'
      - Effect: 'Allow' # for the global secondary index of signatures table
        Action:
          - dynamodb:Query
        Resource:
          - Fn::Join:
              - '/'
              - - { 'Fn::GetAtt': ['SignaturesTable', 'Arn'] }
                - 'index/userIdIndex'

  createSignatureListAuth:
    handler: src/api/signatures/createSignatureList/index.handler
    events:
      - http:
          path: users/{userId}/signatures
          method: post
          cors: true
          request:
            parameters:
              paths:
                userId: true # not optional
          authorizer:
            type: COGNITO_USER_POOLS
            authorizerId:
              Ref: ApiGatewayAuthorizer
    memorySize: 1600 # memorySize for this specific function.
    timeout: 12 # Timeout for this specific function.
    iamRoleStatements:
      - Effect: 'Allow'
        Action:
          - dynamodb:GetItem
          - dynamodb:Scan
          - dynamodb:UpdateItem
        Resource:
          - 'Fn::GetAtt': [UsersTable, Arn]
      - Effect: 'Allow' # for the global secondary index
        Action:
          - dynamodb:Query
        Resource:
          - Fn::Join:
              - '/'
              - - { 'Fn::GetAtt': ['UsersTable', 'Arn'] }
                - 'index/emailIndex'
      - Effect: 'Allow'
        Action:
          - dynamodb:PutItem
          - dynamodb:GetItem
          - dynamodb:Scan
          - dynamodb:Query
          - dynamodb:UpdateItem
        Resource:
          - 'Fn::GetAtt': [SignaturesTable, Arn]
      - Effect: 'Allow'
        Action:
          - ses:SendEmail
          - ses:SendRawEmail
        Resource: 'arn:aws:ses:eu-central-1:550953582247:identity/support@expedition-grundeinkommen.de'
      - Effect: 'Allow'
        Action:
          - s3:PutObject
          - s3:PutObjectAcl
        Resource: 'arn:aws:s3:::${self:custom.listsBucketName}/*'
      - Effect: 'Allow' # for the global secondary index of signatures table
        Action:
          - dynamodb:Query
        Resource:
          - Fn::Join:
              - '/'
              - - { 'Fn::GetAtt': ['SignaturesTable', 'Arn'] }
                - 'index/userIdIndex'

  updateSignatureList:
    handler: src/api/signatures/updateSignatureList/index.handler
    events:
      - http:
          path: signatures/{listId}
          method: patch
          cors: true
          request:
            parameters:
              paths:
                listId: true # not optional
    iamRoleStatements:
      - Effect: 'Allow'
        Action:
          - dynamodb:GetItem
          - dynamodb:UpdateItem
          - dynamodb:Scan
          - dynamodb:PutItem
        Resource:
          - 'Fn::GetAtt': [SignaturesTable, Arn]
      - Effect: 'Allow'
        Action:
          - dynamodb:Scan
          - dynamodb:Query
          - dynamodb:GetItem
          - dynamodb:UpdateItem
        Resource:
          - 'Fn::GetAtt': [UsersTable, Arn]
      - Effect: 'Allow' # for the global secondary index
        Action:
          - dynamodb:Query
        Resource:
          - Fn::Join:
              - '/'
              - - { 'Fn::GetAtt': ['UsersTable', 'Arn'] }
                - 'index/emailIndex'

  adminUpdateSignatureList:
    handler: src/api/signatures/adminUpdateSignatureList/index.handler
    events:
      - http:
          path: admin/signatures/{listId}
          method: patch
          cors: true
          request:
            parameters:
              paths:
                listId: true # not optional
          authorizer:
            type: COGNITO_USER_POOLS
            authorizerId:
              Ref: AdminApiGatewayAuthorizer
    iamRoleStatements:
      - Effect: 'Allow'
        Action:
          - dynamodb:GetItem
          - dynamodb:UpdateItem
        Resource:
          - 'Fn::GetAtt': [SignaturesTable, Arn]

  getSignatureCount:
    handler: src/api/signatures/getSignatureCount/index.handler
    events:
      - http:
          path: analytics/signatures
          method: get
          cors: true
    memorySize: 1024 # memorySize for this specific function.
    timeout: 12 # Timeout for this specific function.
    iamRoleStatements:
      - Effect: 'Allow'
        Action:
          - dynamodb:Scan
          - dynamodb:GetItem
        Resource:
          - 'Fn::GetAtt': [SignaturesTable, Arn]
      - Effect: 'Allow'
        Action:
          - dynamodb:Scan
          - dynamodb:GetItem
        Resource:
          - 'Fn::GetAtt': [UsersTable, Arn]
      - Effect: 'Allow' # for the global secondary index
        Action:
          - dynamodb:Query
        Resource:
          - Fn::Join:
              - '/'
              - - { 'Fn::GetAtt': ['UsersTable', 'Arn'] }
                - 'index/emailIndex'
      - Effect: 'Allow' # for the global secondary index of signatures table
        Action:
          - dynamodb:Query
        Resource:
          - Fn::Join:
              - '/'
              - - { 'Fn::GetAtt': ['SignaturesTable', 'Arn'] }
                - 'index/userIdIndex'

  getSignatureHistory:
    handler: src/api/signatures/getSignatureHistory/index.handler
    events:
      - http:
          path: analytics/signatures/history
          method: get
          cors: true
    iamRoleStatements:
      - Effect: 'Allow'
        Action:
          - dynamodb:Scan
        Resource:
          - 'Fn::GetAtt': [SignaturesTable, Arn]

  getUserCount:
    handler: src/api/users/getUserCount/index.handler
    events:
      - http:
          path: analytics/users
          method: get
          cors: true
          caching:
            enabled: true
            ttlInSeconds: 600
            perKeyInvalidation:
              requireAuthorization: true # default is true
              handleUnauthorizedRequests: Ignore # default is "IgnoreWithWarning"
    environment:
      USER_POOL_ID:
        Ref: CognitoUserPoolUserPool
    timeout: 40 # Timeout for this specific function.
    iamRoleStatements:
      - Effect: 'Allow'
        Action:
          - dynamodb:Scan
        Resource:
          - 'arn:aws:dynamodb:eu-central-1:550953582247:table/users-without-consent'
      - Effect: 'Allow'
        Action:
          - dynamodb:Scan
        Resource:
          - 'Fn::GetAtt': [UsersTable, Arn]
      - Effect: 'Allow'
        Action:
          - cognito-idp:ListUsers
        Resource:
          - 'Fn::GetAtt': [CognitoUserPoolUserPool, Arn]

  getListCount:
    handler: src/api/signatures/getSignatureListCount/index.handler
    events:
      - http:
          path: analytics/signatures/lists
          method: get
          cors: true
          caching:
            enabled: true
            ttlInSeconds: 600
    iamRoleStatements:
      - Effect: 'Allow'
        Action:
          - dynamodb:Scan
        Resource:
          - 'Fn::GetAtt': [SignaturesTable, Arn]

  createUser:
    handler: src/api/users/createUser/index.handler
    events:
      - http:
          path: users
          method: post
          cors: true
    iamRoleStatements:
      - Effect: 'Allow'
        Action:
          - dynamodb:GetItem
          - dynamodb:PutItem
          - dynamodb:Scan
        Resource:
          - 'Fn::GetAtt': [UsersTable, Arn]
      - Effect: 'Allow'
        Action:
          - dynamodb:GetItem
        Resource:
          - 'Fn::GetAtt': [MunicipalitiesTable, Arn]
      - Effect: 'Allow'
        Action:
          - dynamodb:PutItem
          - dynamodb:GetItem
        Resource:
          - 'Fn::GetAtt': [UserMunicipalityTable, Arn]

  # Probably not needed in the future
  # createUserExternal:
  #   handler: src/api/users/createUserExternal/index.handler
  #   events:
  #     - http:
  #         path: users/external-signup
  #         method: post
  #         cors: true
  #   environment:
  #     USER_POOL_ID:
  #       Ref: CognitoUserPoolUserPool
  #   iamRoleStatements:
  #     - Effect: 'Allow'
  #       Action:
  #         - dynamodb:PutItem
  #         - dynamodb:UpdateItem
  #       Resource:
  #         - 'Fn::GetAtt': [UsersTable, Arn]
  #     - Effect: 'Allow' # for the global secondary index
  #       Action:
  #         - dynamodb:Query
  #       Resource:
  #         - Fn::Join:
  #             - '/'
  #             - - { 'Fn::GetAtt': ['UsersTable', 'Arn'] }
  #               - 'index/emailIndex'
  #     - Effect: 'Allow'
  #       Action:
  #         - cognito-idp:AdminCreateUser
  #         - cognito-idp:AdminSetUserPassword
  #       Resource:
  #         - 'Fn::GetAtt': [CognitoUserPoolUserPool, Arn]
  #     - Effect: 'Allow'
  #       Action:
  #         - dynamodb:GetItem
  #       Resource:
  #         - 'Fn::GetAtt': [MunicipalitiesTable, Arn]
  #     - Effect: 'Allow'
  #       Action:
  #         - dynamodb:PutItem
  #         - dynamodb:GetItem
  #       Resource:
  #         - 'Fn::GetAtt': [UserMunicipalityTable, Arn]

  getUser:
    handler: src/api/users/getUser/index.handler
    events:
      - http:
          path: users/{userId}
          method: get
          cors: true
          request:
            parameters:
              paths:
                userId: true # not optional
    iamRoleStatements:
      - Effect: 'Allow'
        Action:
          - dynamodb:GetItem
        Resource:
          - 'Fn::GetAtt': [UsersTable, Arn]
      - Effect: 'Allow'
        Action:
          - dynamodb:Query
        Resource:
          - 'Fn::GetAtt': [UserMunicipalityTable, Arn]
      - Effect: 'Allow'
        Action:
          - dynamodb:GetItem
        Resource:
          - 'Fn::GetAtt': [MunicipalitiesTable, Arn]

  getCurrentUser:
    handler: src/api/users/getCurrentUser/index.handler
    events:
      - http:
          path: users/me
          method: get
          cors: true
          authorizer:
            type: COGNITO_USER_POOLS
            authorizerId:
              Ref: ApiGatewayAuthorizer
    iamRoleStatements:
      - Effect: 'Allow'
        Action:
          - dynamodb:GetItem
        Resource:
          - 'Fn::GetAtt': [UsersTable, Arn]
      - Effect: 'Allow'
        Action:
          - dynamodb:Query
        Resource:
          - 'Fn::GetAtt': [UserMunicipalityTable, Arn]
      - Effect: 'Allow'
        Action:
          - dynamodb:GetItem
        Resource:
          - 'Fn::GetAtt': [MunicipalitiesTable, Arn]

  createQuestion:
    handler: src/api/users/questions/createQuestion/index.handler
    events:
      - http:
          path: users/{userId}/questions
          method: post
          cors: true
          request:
            parameters:
              paths:
                userId: true # not optional
    iamRoleStatements:
      - Effect: 'Allow'
        Action:
          - dynamodb:GetItem
          - dynamodb:PutItem
          - dynamodb:UpdateItem
        Resource:
          - 'Fn::GetAtt': [UsersTable, Arn]

  updateUser:
    handler: src/api/users/updateUser/index.handler
    events:
      - http:
          path: users/{userId}
          method: patch
          cors: true
          request:
            parameters:
              paths:
                userId: true # not optional
          authorizer:
            type: COGNITO_USER_POOLS
            authorizerId:
              Ref: ApiGatewayAuthorizer
    iamRoleStatements:
      - Effect: 'Allow'
        Action:
          - dynamodb:GetItem
          - dynamodb:UpdateItem
        Resource:
          - 'Fn::GetAtt': [UsersTable, Arn]
      - Effect: 'Allow'
        Action:
          - dynamodb:GetItem
        Resource:
          - 'Fn::GetAtt': [MunicipalitiesTable, Arn]
      - Effect: 'Allow'
        Action:
          - dynamodb:PutItem
          - dynamodb:GetItem
        Resource:
          - 'Fn::GetAtt': [UserMunicipalityTable, Arn]

  deleteUser:
    handler: src/api/users/deleteUser/index.handler
    events:
      - http:
          path: users/{userId}
          method: delete
          cors: true
          request:
            parameters:
              paths:
                userId: true # not optional
          authorizer:
            type: COGNITO_USER_POOLS
            authorizerId:
              Ref: ApiGatewayAuthorizer
    environment:
      USER_POOL_ID:
        Ref: CognitoUserPoolUserPool
    iamRoleStatements:
      - Effect: 'Allow'
        Action:
          - dynamodb:GetItem
          - dynamodb:DeleteItem
        Resource:
          - 'Fn::GetAtt': [UsersTable, Arn]
      - Effect: 'Allow'
        Action:
          - cognito-idp:AdminDeleteUser
        Resource:
          - 'Fn::GetAtt': [CognitoUserPoolUserPool, Arn]

  unsubscribeUser:
    handler: src/api/users/unsubscribeUser/index.handler
    events:
      - http:
          path: users/unsubscribe-callback
          method: post
          cors: true
    iamRoleStatements:
      - Effect: 'Allow'
        Action:
          - dynamodb:UpdateItem
        Resource:
          - 'Fn::GetAtt': [UsersTable, Arn]
      - Effect: 'Allow' # for the global secondary index
        Action:
          - dynamodb:Query
        Resource:
          - Fn::Join:
              - '/'
              - - { 'Fn::GetAtt': ['UsersTable', 'Arn'] }
                - 'index/emailIndex'

  confirmUser:
    handler: src/api/users/confirmUser/index.handler
    events:
      - http:
          path: users/{userId}/confirm
          method: post
          cors: true
          request:
            parameters:
              paths:
                userId: true # not optional
    iamRoleStatements:
      - Effect: 'Allow'
        Action:
          - dynamodb:GetItem
          - dynamodb:UpdateItem
        Resource:
          - 'Fn::GetAtt': [UsersTable, Arn]

  createSurveyAnswer:
    handler: src/api/users/createSurveyAnswer/index.handler
    events:
      - http:
          path: users/{userId}/surveys
          method: post
          cors: true
          request:
            parameters:
              paths:
                userId: true # not optional
    iamRoleStatements:
      - Effect: 'Allow'
        Action:
          - dynamodb:GetItem
          - dynamodb:UpdateItem
        Resource:
          - 'Fn::GetAtt': [UsersTable, Arn]

  getMunicipalities:
    handler: src/api/municipalities/getMunicipalities/index.handler
    events:
      - http:
          path: municipalities
          method: get
          cors: true

  getMunicipalityStats:
    handler: src/api/municipalities/getMunicipalityStats/index.handler
    events:
      - http:
          path: analytics/municipalities/{ags}
          method: get
          cors: true
    iamRoleStatements:
      - Effect: 'Allow'
        Action:
          - dynamodb:GetItem
        Resource:
          - 'Fn::GetAtt': [MunicipalitiesTable, Arn]
      - Effect: 'Allow'
        Action:
          - dynamodb:Query
        Resource:
          - Fn::Join:
              - '/'
              - - { 'Fn::GetAtt': ['UserMunicipalityTable', 'Arn'] }
                - 'index/agsIndex'

  getMunicipalitiesStats:
    handler: src/api/municipalities/getMunicipalitiesStats/index.handler
    timeout: 30 # Timeout for this specific function.
    events:
      - http:
          path: analytics/municipalities
          method: get
          cors: true
    iamRoleStatementsName: ${self:custom.stage}-get-municipalities-stats-role
    iamRoleStatements:
      - Effect: Allow
        Action:
          - s3:HeadObject
          - s3:GetObject
        Resource: 'arn:aws:s3:::xbge-municipalities-stats/*'

  createMunicipalitiesStats:
    handler: src/api/municipalities/createMunicipalitiesStats/index.handler
    timeout: 300
    events: # Call this function every x minutes
      - schedule: rate(15 minutes)
    iamRoleStatementsName: ${self:custom.stage}-create-municipalities-stats-role
    iamRoleStatements:
      - Effect: 'Allow'
        Action:
          - dynamodb:GetItem
          - dynamodb:Scan
        Resource:
          - 'Fn::GetAtt': [MunicipalitiesTable, Arn]
      - Effect: 'Allow'
        Action:
          - dynamodb:GetItem
          - dynamodb:Scan
        Resource:
          - 'Fn::GetAtt': [UserMunicipalityTable, Arn]
      - Effect: Allow
        Action:
          - s3:HeadObject
          - s3:PutObject
          - s3:PutObjectAcl
          - s3:GetObject
        Resource: 'arn:aws:s3:::xbge-municipalities-stats/*'

  adminCreateUser:
    handler: src/api/users/adminCreateUser/index.handler
    events:
      - http:
          path: admin/users
          method: post
          cors: true
          authorizer:
            type: COGNITO_USER_POOLS
            authorizerId:
              Ref: AdminApiGatewayAuthorizer
    environment:
      USER_POOL_ID:
        Ref: CognitoUserPoolUserPool
    iamRoleStatements:
      - Effect: 'Allow'
        Action:
          - dynamodb:PutItem
          - dynamodb:Scan
          - dynamodb:UpdateItem
        Resource:
          - 'Fn::GetAtt': [UsersTable, Arn]
      - Effect: 'Allow' # for the global secondary index
        Action:
          - dynamodb:Query
        Resource:
          - Fn::Join:
              - '/'
              - - { 'Fn::GetAtt': ['UsersTable', 'Arn'] }
                - 'index/emailIndex'
      - Effect: 'Allow'
        Action:
          - ses:SendEmail
          - ses:SendRawEmail
        Resource: 'arn:aws:ses:eu-central-1:550953582247:identity/support@expedition-grundeinkommen.de'
      - Effect: 'Allow'
        Action:
          - cognito-idp:AdminCreateUser
          - cognito-idp:AdminSetUserPassword
        Resource:
          - 'Fn::GetAtt': [CognitoUserPoolUserPool, Arn]

  adminGetUsers:
    handler: src/api/users/adminGetUsers/index.handler
    events:
      - http:
          path: admin/users
          method: get
          cors: true
          caching:
            enabled: true
            ttlInSeconds: 600
          authorizer:
            type: COGNITO_USER_POOLS
            authorizerId:
              Ref: AdminApiGatewayAuthorizer
    memorySize: 1024 # memorySize for this specific function.
    timeout: 30 # Timeout for this specific function.
    iamRoleStatements:
      - Effect: 'Allow'
        Action:
          - dynamodb:GetItem
        Resource:
          - 'Fn::GetAtt': [UsersTable, Arn]
      - Effect: 'Allow' # for the global secondary index of signatures table
        Action:
          - dynamodb:Query
        Resource:
          - Fn::Join:
              - '/'
              - - { 'Fn::GetAtt': ['SignaturesTable', 'Arn'] }
                - 'index/userIdIndex'
      - Effect: 'Allow' # for the global secondary index
        Action:
          - dynamodb:Query
        Resource:
          - Fn::Join:
              - '/'
              - - { 'Fn::GetAtt': ['UsersTable', 'Arn'] }
                - 'index/emailIndex'
      - Effect: 'Allow'
        Action:
          - dynamodb:Scan
        Resource:
          - 'Fn::GetAtt': [SignaturesTable, Arn]
      - Effect: 'Allow'
        Action:
          - dynamodb:GetItem
        Resource:
          - 'Fn::GetAtt': [SignaturesTable, Arn]

  adminGetDonations:
    handler: src/api/users/adminGetDonations/index.handler
    events:
      - http:
          path: admin/donations
          method: get
          cors: true
          authorizer:
            type: COGNITO_USER_POOLS
            authorizerId:
              Ref: AdminApiGatewayAuthorizer
    memorySize: 1024 # memorySize for this specific function.
    timeout: 30 # Timeout for this specific function.
    iamRoleStatements:
      - Effect: 'Allow'
        Action:
          - dynamodb:Scan
        Resource:
          - 'Fn::GetAtt': [UsersTable, Arn]

  mergeReferredUsers:
    handler: src/triggers/mergeReferredUsers/index.handler
    events:
      - schedule: rate(60 minutes)
    timeout: 100 # Timeout for this specific function.
    iamRoleStatements:
      - Effect: 'Allow'
        Action:
          - dynamodb:GetItem
          - dynamodb:UpdateItem
          - dynamodb:Scan
        Resource:
          - 'Fn::GetAtt': [UsersTable, Arn]

  deleteUnverified:
    handler: src/triggers/deleteUnverifiedUsers/index.handler
    events: # Call this function every day at 0 am (via cloudwatch event)
      - schedule: cron(0 23 * * ? *)
    timeout: 100 # Timeout for this specific function.
    environment:
      USER_POOL_ID:
        Ref: CognitoUserPoolUserPool
    iamRoleStatements:
      - Effect: 'Allow'
        Action:
          - cognito-idp:ListUsers
          - cognito-idp:AdminDeleteUser
        Resource:
          - 'Fn::GetAtt': [CognitoUserPoolUserPool, Arn]
      - Effect: 'Allow'
        Action:
          - dynamodb:DeleteItem
          - dynamodb:Scan
        Resource:
          - 'Fn::GetAtt': [UsersTable, Arn]

  onVerification:
    handler: src/triggers/auth/onVerification/index.handler
    events:
      - cognitoUserPool:
          pool: UserPool
          trigger: PostConfirmation
    iamRoleStatements:
      - Effect: 'Allow'
        Action:
          - dynamodb:GetItem
        Resource:
          - 'Fn::GetAtt': [UsersTable, Arn]

  updateMailjetContact:
    handler: src/triggers/mailjet/updateMailjetContact/index.handler
    events: # dynamodb trigger through a dynamo stream
      - stream:
          type: dynamodb
          maximumRetryAttempts: 5
          arn:
            Fn::GetAtt: [UsersTable, StreamArn]
      - stream:
          type: dynamodb
          maximumRetryAttempts: 5
          arn:
            Fn::GetAtt: [SignaturesTable, StreamArn]
    environment:
      USER_POOL_ID:
        Ref: CognitoUserPoolUserPool
    iamRoleStatements:
      - Effect: 'Allow'
        Action:
          - dynamodb:GetShardIterator
          - dynamodb:DescribeStream
          - dynamodb:GetRecords
          - dynamodb:ListStreams
        Resource:
          - 'Fn::GetAtt': [UsersTable, StreamArn]
      - Effect: 'Allow'
        Action:
          - mobiletargeting:*
        Resource: 'arn:aws:mobiletargeting:*:550953582247:*'
      - Effect: 'Allow'
        Action:
          - dynamodb:GetItem
        Resource:
          - 'Fn::GetAtt': [UsersTable, Arn]
      - Effect: 'Allow'
        Action:
          - dynamodb:Scan
        Resource:
          - 'Fn::GetAtt': [SignaturesTable, Arn]
      - Effect: 'Allow'
        Action:
          - cognito-idp:AdminGetUser
        Resource:
          - 'Fn::GetAtt': [CognitoUserPoolUserPool, Arn]
      - Effect: 'Allow' # for the global secondary index of signatures table
        Action:
          - dynamodb:Query
        Resource:
          - Fn::Join:
              - '/'
              - - { 'Fn::GetAtt': ['SignaturesTable', 'Arn'] }
                - 'index/userIdIndex'
      - Effect: 'Allow'
        Action:
          - dynamodb:Query
        Resource:
          - 'Fn::GetAtt': [UserMunicipalityTable, Arn]
      - Effect: 'Allow'
        Action:
          - dynamodb:GetItem
        Resource:
          - 'Fn::GetAtt': [MunicipalitiesTable, Arn]
      - Effect: 'Allow'
        Action:
          - dynamodb:Query
        Resource:
          - Fn::Join:
              - '/'
              - - { 'Fn::GetAtt': ['UserMunicipalityTable', 'Arn'] }
                - 'index/agsIndex'

  fillMailjet:
    handler: src/triggers/mailjet/fillMailjet/index.handler
    # events: # Call this function every day at 0 am (via cloudwatch event)
    #   - schedule: cron(0 23 * * ? *)
    timeout: 900 # Timeout for this specific function. Takes a while...
    memorySize: 2048 # memorySize for this specific function.
    environment:
      USER_POOL_ID:
        Ref: CognitoUserPoolUserPool
    iamRoleStatements:
      - Effect: 'Allow'
        Action:
          - mobiletargeting:*
        Resource: 'arn:aws:mobiletargeting:*:550953582247:*'
      - Effect: 'Allow'
        Action:
          - dynamodb:Scan
        Resource:
          - 'Fn::GetAtt': [UsersTable, Arn]
      - Effect: 'Allow'
        Action:
          - dynamodb:Scan
        Resource:
          - 'Fn::GetAtt': [SignaturesTable, Arn]
      - Effect: 'Allow'
        Action:
          - cognito-idp:ListUsers
        Resource:
          - 'Fn::GetAtt': [CognitoUserPoolUserPool, Arn]
      - Effect: Allow
        Action:
          - lambda:InvokeFunction
          - lambda:InvokeAsync
        Resource: 'arn:aws:lambda:eu-central-1:550953582247:function:ubi-serverless-prod-fillMailjet'
      - Effect: 'Allow' # for the global secondary index of signatures table
        Action:
          - dynamodb:Query
        Resource:
          - Fn::Join:
              - '/'
              - - { 'Fn::GetAtt': ['SignaturesTable', 'Arn'] }
                - 'index/userIdIndex'
      - Effect: 'Allow'
        Action:
          - dynamodb:Query
        Resource:
          - 'Fn::GetAtt': [UserMunicipalityTable, Arn]
      - Effect: 'Allow'
        Action:
          - dynamodb:GetItem
        Resource:
          - 'Fn::GetAtt': [MunicipalitiesTable, Arn]
      - Effect: 'Allow'
        Action:
          - dynamodb:Query
        Resource:
          - Fn::Join:
              - '/'
              - - { 'Fn::GetAtt': ['UserMunicipalityTable', 'Arn'] }
                - 'index/agsIndex'

  sendCongratulationMails:
    handler: src/triggers/sendCongratulationMails/index.handler
    events: # Call this function every day at 8:30 (via cloudwatch event)
      - schedule: cron(30 19 * * ? *)
    memorySize: 2048 # memorySize for this specific function.
    timeout: 300 # Timeout for this specific function.
    iamRoleStatements:
      - Effect: 'Allow'
        Action:
          - dynamodb:GetItem
        Resource:
          - 'Fn::GetAtt': [UsersTable, Arn]
      - Effect: 'Allow'
        Action:
          - dynamodb:Scan
        Resource:
          - 'Fn::GetAtt': [SignaturesTable, Arn]
      - Effect: 'Allow' # for the global secondary index of signatures table
        Action:
          - dynamodb:Query
        Resource:
          - Fn::Join:
              - '/'
              - - { 'Fn::GetAtt': ['SignaturesTable', 'Arn'] }
                - 'index/userIdIndex'
      - Effect: 'Allow'
        Action:
          - ses:SendEmail
          - ses:SendRawEmail
        Resource: 'arn:aws:ses:eu-central-1:550953582247:identity/support@expedition-grundeinkommen.de'

  requestImageUpload:
    handler: src/api/images/requestImageUpload/index.handler
    events:
      - http:
          path: images/upload-url
          method: post
          cors: true
    iamRoleStatements:
      - Effect: 'Allow'
        Action:
          - dynamodb:GetItem
        Resource:
          - 'Fn::GetAtt': [UsersTable, Arn]
      - Effect: 'Allow'
        Action:
          - s3:PutObject
          - s3:PutObjectAcl
        Resource: 'arn:aws:s3:::${self:custom.imageBucketName}/*'

  processUploadedImage:
    handler: src/triggers/processUploadedImage/index.handler
    events:
      - s3:
          bucket: imageBucket
          event: s3:ObjectCreated:*
          rules:
            - prefix: ${self:custom.stage}/originals/
    timeout: 30 # Timeout for this specific function.
    memorySize: 1600 # memorySize for this specific function.
    environment:
      S3_IMAGES_URL: https://${self:custom.imageBucketName}.s3.eu-central-1.amazonaws.com
    iamRoleStatements:
      - Effect: 'Allow'
        Action:
          - dynamodb:UpdateItem
          - dynamodb:GetItem
        Resource:
          - 'Fn::GetAtt': [UsersTable, Arn]
      - Effect: Allow
        Action:
          - s3:GetObject
          - s3:HeadObject
          - s3:PutObject
          - s3:PutObjectAcl
          - s3:DeleteObject
        Resource: 'arn:aws:s3:::${self:custom.imageBucketName}/*'

  saveMapAsImage:
    handler: src/triggers/saveMapAsImage/index.handler
    events:
      - schedule: rate(15 minutes)
    timeout: 60
    memorySize: 2048
    iamRoleStatements:
      - Effect: Allow
        Action:
          - s3:PutObject
          - s3:PutObjectAcl
        Resource: 'arn:aws:s3:::xbge-map-images/*'

  # getQuestions:
  #   handler: src/api/users/questions/getQuestions/index.handler
  #   events:
  #     - http:
  #         path: questions
  #         method: get
  #         cors: true
  #   iamRoleStatements:
  #     - Effect: 'Allow'
  #       Action:
  #         - dynamodb:Scan
  #       Resource:
  #         - 'Fn::GetAtt': [UsersTable, Arn]

  sendGoalMails:
    handler: src/triggers/municipalities/sendGoalMails/index.handler
    timeout: 900 # Timeout for this specific function. Might take a while
    events: # Call this function every hour between 8am and 9pm
      - schedule: cron(0 8-21 * * ? *)
    iamRoleStatements:
      - Effect: 'Allow'
        Action:
          - dynamodb:GetItem
        Resource:
          - 'Fn::GetAtt': [UsersTable, Arn]
      - Effect: 'Allow'
        Action:
          - dynamodb:Query
        Resource:
          - Fn::Join:
              - '/'
              - - { 'Fn::GetAtt': ['UserMunicipalityTable', 'Arn'] }
                - 'index/agsIndex'
      - Effect: 'Allow'
        Action:
          - dynamodb:GetItem
        Resource:
          - 'Fn::GetAtt': [MunicipalitiesTable, Arn]
      - Effect: Allow
        Action:
          - s3:HeadObject
          - s3:GetObject
        Resource: 'arn:aws:s3:::xbge-municipalities-stats/*'
      - Effect: 'Allow'
        Action:
          - ses:SendEmail
          - ses:SendRawEmail
        Resource: 'arn:aws:ses:eu-central-1:550953582247:identity/support@expedition-grundeinkommen.de'
      - Effect: 'Allow'
        Action:
          - dynamodb:UpdateItem
        Resource:
          - 'Fn::GetAtt': [UserMunicipalityTable, Arn]

  sendWelcomeMails:
    handler: src/triggers/municipalities/sendWelcomeMails/index.handler
    timeout: 900 # Timeout for this specific function. Might take a while
    events: # Call this function every day at 6:05 pm (via cloudwatch event)
      - schedule: cron(5 17 * * ? *)
    iamRoleStatements:
      - Effect: 'Allow'
        Action:
          - dynamodb:GetItem
        Resource:
          - 'Fn::GetAtt': [UsersTable, Arn]
      - Effect: 'Allow'
        Action:
          - dynamodb:Scan
        Resource:
          - 'Fn::GetAtt': [UserMunicipalityTable, Arn]
      - Effect: 'Allow'
        Action:
          - ses:SendEmail
          - ses:SendRawEmail
        Resource: 'arn:aws:ses:eu-central-1:550953582247:identity/support@expedition-grundeinkommen.de'
      - Effect: 'Allow'
        Action:
          - dynamodb:GetItem
        Resource:
          - 'Fn::GetAtt': [MunicipalitiesTable, Arn]

  sendReminderMails:
    handler: src/triggers/sendReminderMails/index.handler
    timeout: 900 # Timeout for this specific function. Takes a while...
    events: # Call this function every day at 7 pm (via cloudwatch event)
      - schedule: cron(0 18 * * ? *)
    iamRoleStatements:
      - Effect: 'Allow'
        Action:
          - dynamodb:GetItem
        Resource:
          - 'Fn::GetAtt': [UsersTable, Arn]
      - Effect: 'Allow'
        Action:
          - dynamodb:Scan
        Resource:
          - 'Fn::GetAtt': [SignaturesTable, Arn]
      - Effect: 'Allow' # for the global secondary index of signatures table
        Action:
          - dynamodb:Query
        Resource:
          - Fn::Join:
              - '/'
              - - { 'Fn::GetAtt': ['SignaturesTable', 'Arn'] }
                - 'index/userIdIndex'

  getCrowdfundingData:
    handler: src/api/crowdfunding/getCrowdfundingData/index.handler
    events:
      - http:
          path: analytics/crowdfunding
          method: get
          cors: true

  shareMunicipality:
    handler: src/misc/shareMunicipality/index.handler
    events:
      - http:
          path: share-municipality/{userId}
          method: get
          cors: true
          request:
            parameters:
              paths:
                userId: true # not optional
    iamRoleStatements:
      - Effect: 'Allow'
        Action:
          - dynamodb:GetItem
        Resource:
          - 'Fn::GetAtt': [UsersTable, Arn]
      - Effect: 'Allow'
        Action:
          - dynamodb:GetItem
        Resource:
          - 'Fn::GetAtt': [MunicipalitiesTable, Arn]
      - Effect: 'Allow'
        Action:
          - dynamodb:Query
        Resource:
          - Fn::Join:
              - '/'
              - - { 'Fn::GetAtt': ['UserMunicipalityTable', 'Arn'] }
                - 'index/agsIndex'
      - Effect: 'Allow'
        Action:
          - s3:PutObject
          - s3:PutObjectAcl
        Resource: 'arn:aws:s3:::xbge-personalized-sharing-images/*'

  signIn:
    handler: src/api/users/signIn/index.handler
    events:
      - http:
          path: users/sign-in
          method: post
          cors: true
    environment:
      USER_POOL_ID:
        Ref: CognitoUserPoolUserPool
    iamRoleStatements:
      - Effect: 'Allow'
        Action:
          - dynamodb:GetItem
        Resource:
          - 'Fn::GetAtt': [UsersTable, Arn]
      - Effect: 'Allow'
        Action:
          - cognito-idp:AdminUpdateUserAttributes
        Resource:
          - 'Fn::GetAtt': [CognitoUserPoolUserPool, Arn]
      - Effect: 'Allow'
        Action:
          - ses:SendEmail
          - ses:SendRawEmail
        Resource: 'arn:aws:ses:eu-central-1:550953582247:identity/support@expedition-grundeinkommen.de'

  # User cognito auth triggers

  createAuthChallenge:
    handler: src/triggers/auth/createAuthChallenge/index.handler
    events:
      - cognitoUserPool:
          pool: UserPool
          trigger: CreateAuthChallenge
    iamRoleStatements:
      - Effect: 'Allow'
        Action:
          - ses:SendEmail
          - ses:SendRawEmail
        Resource: 'arn:aws:ses:eu-central-1:550953582247:identity/support@expedition-grundeinkommen.de'
      - Effect: 'Allow'
        Action:
          - dynamodb:GetItem
        Resource:
          - 'Fn::GetAtt': [UsersTable, Arn]

  defineAuthChallenge:
    handler: src/triggers/auth/defineAuthChallenge/index.handler
    events:
      - cognitoUserPool:
          pool: UserPool
          trigger: DefineAuthChallenge

  preSignUp:
    handler: src/triggers/auth/preSignUp/index.handler
    events:
      - cognitoUserPool:
          pool: UserPool
          trigger: PreSignUp

  verifyAuthChallengeResponse:
    handler: src/triggers/auth/verifyAuthChallengeResponse/index.handler
    events:
      - cognitoUserPool:
          pool: UserPool
          trigger: VerifyAuthChallengeResponse
    iamRoleStatements:
      - Effect: 'Allow'
        Action:
          - ses:SendEmail
          - ses:SendRawEmail
        Resource: 'arn:aws:ses:${self:provider.region}:*:*'

  # Admin cognito auth triggers

  adminCreateAuthChallenge:
    handler: src/triggers/adminAuth/createAuthChallenge/index.handler
    events:
      - cognitoUserPool:
          pool: AdminUserPool
          trigger: CreateAuthChallenge
    environment:
      SES_FROM_ADDRESS: support@expedition-grundeinkommen.de
    iamRoleStatements:
      - Effect: 'Allow'
        Action:
          - ses:SendEmail
          - ses:SendRawEmail
        Resource: 'arn:aws:ses:eu-central-1:550953582247:identity/support@expedition-grundeinkommen.de'
      - Effect: 'Allow'
        Action:
          - dynamodb:GetItem
        Resource:
          - 'Fn::GetAtt': [UsersTable, Arn]

  adminDefineAuthChallenge:
    handler: src/triggers/adminAuth/defineAuthChallenge/index.handler
    events:
      - cognitoUserPool:
          pool: AdminUserPool
          trigger: DefineAuthChallenge

  adminPreSignUp:
    handler: src/triggers/adminAuth/preSignUp/index.handler
    events:
      - cognitoUserPool:
          pool: AdminUserPool
          trigger: PreSignUp

  adminVerifyAuthChallengeResponse:
    handler: src/triggers/adminAuth/verifyAuthChallengeResponse/index.handler
    events:
      - cognitoUserPool:
          pool: AdminUserPool
          trigger: VerifyAuthChallengeResponse
    iamRoleStatements:
      - Effect: 'Allow'
        Action:
          - ses:SendEmail
          - ses:SendRawEmail
        Resource: 'arn:aws:ses:${self:provider.region}:*:*'

# CloudFormation resource templates
resources:
  Resources:
    UsersTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.usersTableName}
        AttributeDefinitions:
          - AttributeName: cognitoId
            AttributeType: S
          - AttributeName: email
            AttributeType: S
        KeySchema:
          - AttributeName: cognitoId
            KeyType: HASH
        StreamSpecification:
          StreamViewType: NEW_AND_OLD_IMAGES
        # ProvisionedThroughput:
        # ReadCapacityUnits: 5
        # WriteCapacityUnits: 5
        BillingMode: PAY_PER_REQUEST
        GlobalSecondaryIndexes:
          - IndexName: emailIndex
            KeySchema:
              - AttributeName: email
                KeyType: HASH
            Projection:
              ProjectionType: 'ALL'
            # ProvisionedThroughput:
            #   ReadCapacityUnits: 5
            #   WriteCapacityUnits: 5

    SignaturesTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.signaturesTableName}
        AttributeDefinitions:
          - AttributeName: id
            AttributeType: S
          - AttributeName: userId
            AttributeType: S
        KeySchema:
          - AttributeName: id
            KeyType: HASH
        StreamSpecification:
          StreamViewType: NEW_IMAGE
        ProvisionedThroughput:
          ReadCapacityUnits: 1
          WriteCapacityUnits: 1
        GlobalSecondaryIndexes:
          - IndexName: userIdIndex
            KeySchema:
              - AttributeName: userId
                KeyType: HASH
            Projection:
              ProjectionType: 'ALL'
            ProvisionedThroughput:
              ReadCapacityUnits: 1
              WriteCapacityUnits: 1

    MunicipalitiesTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.municipalitiesTableName}
        AttributeDefinitions:
          - AttributeName: ags
            AttributeType: S
        KeySchema:
          - AttributeName: ags
            KeyType: HASH
        BillingMode: PAY_PER_REQUEST
        # ProvisionedThroughput:
        #   ReadCapacityUnits: 5
        #   WriteCapacityUnits: 5

    UserMunicipalityTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.userMunicipalityTableName}
        AttributeDefinitions:
          - AttributeName: userId
            AttributeType: S
          - AttributeName: ags
            AttributeType: S
        KeySchema:
          - AttributeName: userId
            KeyType: HASH
          - AttributeName: ags
            KeyType: RANGE
        BillingMode: PAY_PER_REQUEST
        GlobalSecondaryIndexes:
          - IndexName: agsIndex
            KeySchema:
              - AttributeName: ags
                KeyType: HASH
              - AttributeName: userId
                KeyType: RANGE
            Projection:
              ProjectionType: 'ALL'

    # General user pool
    # A Cognito User Pool created by an event can be overridden by using the logical resource name
    CognitoUserPoolUserPool:
      Type: AWS::Cognito::UserPool
      Properties:
        # Generate a name based on the stage
        UserPoolName: ${self:custom.stage}-user-pool
        # Set email as an alias
        UsernameAttributes:
          - email
          - phone_number
        AutoVerifiedAttributes:
          - email
          - phone_number
        Schema:
          - Name: source
            Mutable: true
            Required: false
            AttributeDataType: String
          - Name: authChallenge
            Mutable: true
            Required: false
            AttributeDataType: String
            # verified and confirmed should not be used,
            # cannot be deleted though because cognito sucks
          - Name: confirmed
            Mutable: true
            Required: false
            AttributeDataType: Boolean
          - Name: verified
            Mutable: true
            Required: false
            AttributeDataType: Number
        EmailConfiguration:
          EmailSendingAccount: DEVELOPER
          SourceArn: arn:aws:ses:eu-west-1:550953582247:identity/support@expedition-grundeinkommen.de
          From: Expedition Grundeinkommen <support@expedition-grundeinkommen.de>
        SmsConfiguration:
          SnsCallerArn: arn:aws:iam::550953582247:role/service-role/Cognito-SMS-Role
          ExternalId: cf03d420-a229-44ae-9fcd-d5af9e5b594e
        Policies:
          PasswordPolicy: # We generate a fake password anyway (passwordless)
            MinimumLength: 8
            RequireLowercase: false
            RequireNumbers: false
            RequireSymbols: false
            RequireUppercase: false

    UserPoolClient:
      Type: AWS::Cognito::UserPoolClient
      Properties:
        # Generate an app client name based on the stage
        ClientName: ${self:custom.stage}-user-pool-client
        UserPoolId:
          Ref: CognitoUserPoolUserPool
        GenerateSecret: false

    # Authorizer for general user pool
    # https://stackoverflow.com/questions/41664708/cognito-user-pool-authorizer-with-serverless-framework
    ApiGatewayAuthorizer:
      Type: AWS::ApiGateway::Authorizer
      Properties:
        Name: UserPool
        Type: COGNITO_USER_POOLS
        IdentitySource: method.request.header.Authorization
        RestApiId:
          Ref: ApiGatewayRestApi
        ProviderARNs:
          - Fn::GetAtt:
              - CognitoUserPoolUserPool
              - Arn

    # Admin user pool
    # A Cognito User Pool created by an event can be overridden by using the logical resource name
    CognitoUserPoolAdminUserPool:
      Type: AWS::Cognito::UserPool
      Properties:
        # Generate a name based on the stage
        UserPoolName: ${self:custom.stage}-admin-pool
        # Set email as an alias
        UsernameAttributes:
          - email
          - phone_number
        AutoVerifiedAttributes:
          - email
          - phone_number
        EmailConfiguration:
          EmailSendingAccount: DEVELOPER
          SourceArn: arn:aws:ses:eu-west-1:550953582247:identity/support@expedition-grundeinkommen.de
          From: Expedition Grundeinkommen <support@expedition-grundeinkommen.de>
        SmsConfiguration:
          SnsCallerArn: arn:aws:iam::550953582247:role/service-role/Cognito-SMS-Role
          ExternalId: cf03d420-a229-44ae-9fcd-d5af9e5b594e
        Policies:
          PasswordPolicy: # We generate a fake password anyway (passwordless)
            MinimumLength: 8
            RequireLowercase: false
            RequireNumbers: false
            RequireSymbols: false
            RequireUppercase: false

    AdminUserPoolClient:
      Type: AWS::Cognito::UserPoolClient
      Properties:
        # Generate an app client name based on the stage
        ClientName: ${self:custom.stage}-admin-pool-client
        UserPoolId:
          Ref: CognitoUserPoolAdminUserPool
        ExplicitAuthFlows:
          - CUSTOM_AUTH_FLOW_ONLY
        GenerateSecret: false

    # Authorizer for admin user pool
    # https://stackoverflow.com/questions/41664708/cognito-user-pool-authorizer-with-serverless-framework
    AdminApiGatewayAuthorizer:
      Type: AWS::ApiGateway::Authorizer
      Properties:
        Name: AdminUserPool
        Type: COGNITO_USER_POOLS
        IdentitySource: method.request.header.Authorization
        RestApiId:
          Ref: ApiGatewayRestApi
        ProviderARNs:
          - Fn::GetAtt:
              - CognitoUserPoolAdminUserPool
              - Arn

    SignatureListsBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: ${self:custom.listsBucketName}

  # Print out the Id of the User Pool that is created
  Outputs:
    UserPoolId:
      Value:
        Ref: CognitoUserPoolUserPool

    UserPoolClientId:
      Value:
        Ref: UserPoolClient

    AdminUserPoolId:
      Value:
        Ref: CognitoUserPoolAdminUserPool

    AdminUserPoolClientId:
      Value:
        Ref: AdminUserPoolClient
